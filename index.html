<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>AI RESCUE: CATCH DATA ü§ñ</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
    <style>
        :root { --main: #00f2ff; --accent: #bc13fe; --danger: #ff0055; --success: #2ecc71; }
        body { font-family: 'Segoe UI', sans-serif; background: #050a10; color: #fff; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; overflow: hidden; user-select: none; }
        
        #game-area { background: linear-gradient(to bottom, #0d1a2a, #050a10); border: 2px solid var(--main); width: 95%; max-width: 850px; height: 90vh; max-height: 650px; position: relative; overflow: hidden; border-radius: 15px; box-shadow: 0 0 30px rgba(0, 242, 255, 0.3); }
        
        /* Robot nh·ªè g·ªçn h∆°n */
        #player-robot { position: absolute; bottom: 20px; width: 60px; height: 60px; background: rgba(0, 242, 255, 0.1); border: 2px solid var(--main); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 35px; left: 50%; transform: translateX(-50%); z-index: 100; box-shadow: 0 0 15px var(--main); }
        
        .falling-data { position: absolute; top: -80px; width: 170px; min-height: 50px; background: rgba(20, 30, 48, 0.95); border: 2px solid #fff; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 14px; text-align: center; color: #fff; padding: 10px; z-index: 50; box-shadow: 0 5px 15px rgba(0,0,0,0.5); font-weight: bold; pointer-events: none; }
        
        #question-box { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); width: 85%; padding: 20px; background: rgba(0,0,0,0.85); border: 2px solid var(--accent); border-radius: 12px; text-align: center; font-size: 19px; font-weight: bold; color: #fff; z-index: 200; box-shadow: 0 0 20px var(--accent); }
        
        #score-display { position: absolute; top: 15px; left: 25px; font-size: 24px; font-weight: bold; color: var(--main); z-index: 210; }
        #countdown { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 100px; font-weight: bold; color: var(--main); text-shadow: 0 0 30px var(--main); z-index: 300; display: none; }
        #status-msg { position: absolute; top: 140px; left: 50%; transform: translateX(-50%); font-size: 16px; color: var(--main); font-style: italic; z-index: 150; }

        .overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(5, 10, 16, 0.98); z-index: 500; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .overlay input { padding: 12px; border-radius: 8px; border: 1px solid var(--main); background: #000; color: var(--main); width: 280px; margin-bottom: 15px; text-align: center; font-size: 16px; }
        .overlay button { background: var(--main); color: #000; border: none; padding: 15px 50px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 18px; }

        .hit-flash { background-color: var(--danger) !important; transition: 0.1s; }
    </style>
</head>
<body>

<div id="game-area">
    <div id="score-display">SCORE: <span id="current-score">0</span></div>
    <div id="question-box">READY...</div>
    <div id="countdown">5</div>
    <div id="status-msg"></div>
    <div id="player-robot">ü§ñ</div>

    <div id="login-screen" class="overlay">
        <h1 style="color:var(--main)">AI RESCUE FORCE</h1>
        <p style="color:#888; margin-bottom: 20px;">H·ª©ng c√¢u tr·∫£ l·ªùi ƒë√∫ng. ƒê√°p √°n sai s·∫Ω b·ªã lo·∫°i b·ªè!</p>
        <input type="text" id="p-name" placeholder="H·ªå V√Ä T√äN"><br>
        <input type="text" id="p-class" placeholder="L·ªöP"><br>
        <button onclick="startGame()">KH·ªûI CH·∫†Y</button>
    </div>

    <div id="final-screen" class="overlay" style="display: none;">
        <h1 style="color:var(--success)">MISSION COMPLETE</h1>
        <div id="final-score" style="font-size: 60px; color: #fff; margin: 15px 0;"></div>
        <p id="final-rank" style="font-size: 20px; color: var(--accent); margin-bottom: 25px;"></p>
        <button onclick="location.reload()">CH∆†I L·∫†I</button>
    </div>
</div>

<iframe name="hidden_iframe" style="display:none;"></iframe>

<script>
    const CONFIG_FORM = {
        formAction: "https://docs.google.com/forms/d/e/1FAIpQLSda4kGylYwxOjVrfn9VRXVgHqtjg2QhH3KvXYrZKSCrjB3zjQ/formResponse",
        entryName: "entry.2038111055",
        entryClass: "entry.1611801759",
        entryScore: "entry.1076541849"
    };

    const questions = [
        { q: "ƒê·ªÉ AI nh·∫≠n di·ªán 'M·∫∑t c∆∞·ªùi' ch√≠nh x√°c, kh√¥ng ƒë∆∞·ª£c l·∫´n 'M·∫∑t bu·ªìn'. ƒê√¢y l√† ti√™u chu·∫©n?", a: ["ƒê√∫ng (Accuracy)", "ƒê·ªß", "ƒêa d·∫°ng", "ƒê·∫Øt"], c: 0 },
        { q: "AI ch·ªâ h·ªçc ·∫£nh 1 b·∫°n n√™n kh√¥ng nh·∫≠n ƒë∆∞·ª£c c√°c b·∫°n kh√°c. ƒê√¢y l√† l·ªói g√¨?", a: ["Ph·∫ßn c·ª©ng", "L·ªách (Bias)", "B·ªô nh·ªõ", "Virus"], c: 1 },
        { q: "C√¢u 'Garbage In - Garbage Out' nghƒ©a l√† g√¨?", a: ["AI t·ª± d·ªçn r√°c", "D·ªØ li·ªáu r√°c ra k·∫øt qu·∫£ r√°c", "M√°y h·ªèng", "C·∫ßn v·ªá sinh"], c: 1 },
        { q: "Ch·ª•p ·∫£nh nhi·ªÅu g√≥c (tr√°i, ph·∫£i, th·∫≥ng) ƒë·ªÉ ƒë·∫£m b·∫£o?", a: ["ƒê√∫ng", "ƒê·ªß", "ƒêa d·∫°ng (Diversity)", "ƒê·∫πp"], c: 2 },
        { q: "M·ªói nh√£n c·∫£m x√∫c c·∫ßn t·ªëi thi·ªÉu bao nhi√™u ·∫£nh m·∫´u?", a: ["1 t·∫•m", "5 t·∫•m", "15-20 t·∫•m", "1 tri·ªáu"], c: 2 },
        { q: "Khi AI ƒëo√°n sai, ta c·∫ßn quay l·∫°i ki·ªÉm tra ·∫£nh hu·∫•n luy·ªán. ƒê√¢y l√† b∆∞·ªõc?", a: ["X√≥a m√°y", "Truy v·∫øt ngu·ªìn l·ªói", "Ch·ª•p l·∫°i", "N√¢ng c·∫•p RAM"], c: 1 },
        { q: "ƒê·ªÉ m√°y kh√¥ng b·ªã 'L·ªách' (Bias), s·ªë l∆∞·ª£ng ·∫£nh gi·ªØa c√°c nh√£n n√™n?", a: ["√çt ƒëi", "Nhi·ªÅu √≠t kh√°c nhau", "B·∫±ng nhau", "Ng·∫´u nhi√™n"], c: 2 },
        { q: "Th·ª≠ th√°ch Bias (m·ªùi ng∆∞·ªùi l·∫° qu√©t th·ª≠) gi√∫p ki·ªÉm tra t√≠nh?", a: ["ƒê·ªô b·ªÅn", "ƒêa d·∫°ng", "T·ªëc ƒë·ªô", "ƒê·ªô s√°ng"], c: 1 },
        { q: "·∫¢nh c√≥ b√†n tay che m·∫∑t ho·∫∑c v·∫≠t l·∫° che khu·∫•t vi ph·∫°m ch·ªØ ƒê n√†o?", a: ["ƒê√∫ng (Accuracy)", "ƒê·ªß", "ƒê·∫πp", "ƒê·∫Øt"], c: 0 },
        { q: "N·∫øu d·ªØ li·ªáu chu·∫©n m√† m√°y v·∫´n sai, c·∫ßn ch·ªânh g√¨ ·ªü b∆∞·ªõc Train?", a: ["Epochs & Batch size", "Thay Webcam", "X√≥a Form", "T·∫Øt m√°y"], c: 0 }
    ];

    let currentScore = 0, currentQ = 0, gameActive = false;
    let wrongAnswersForThisQ = []; // Danh s√°ch c√°c index ƒë√°p √°n ƒë√£ ch·ªçn sai
    let waveTimeout = null;

    const gameArea = document.getElementById('game-area');
    const robot = document.getElementById('player-robot');
    const countdownEl = document.getElementById('countdown');
    const statusMsg = document.getElementById('status-msg');

    gameArea.addEventListener('mousemove', (e) => {
        if(!gameActive) return;
        let rect = gameArea.getBoundingClientRect();
        let x = e.clientX - rect.left - (robot.offsetWidth/2);
        x = Math.max(10, Math.min(x, gameArea.offsetWidth - robot.offsetWidth - 10));
        robot.style.left = x + 'px';
    });

    function startGame() {
        if(!document.getElementById('p-name').value || !document.getElementById('p-class').value) return alert("Nh·∫≠p th√¥ng tin em nh√©!");
        document.getElementById('login-screen').style.display = 'none';
        gameActive = true;
        loadNextQuestion();
    }

    function loadNextQuestion() {
        if(currentQ >= questions.length) return endGame();
        
        wrongAnswersForThisQ = []; // Reset danh s√°ch ƒë√°p √°n sai cho c√¢u m·ªõi
        document.getElementById('question-box').innerText = `C√ÇU ${currentQ + 1}: ${questions[currentQ].q}`;
        
        let timeLeft = 5;
        countdownEl.innerText = timeLeft;
        countdownEl.style.display = 'block';
        statusMsg.innerText = "ƒê·ªçc k·ªπ c√¢u h·ªèi...";
        
        const timer = setInterval(() => {
            timeLeft--;
            if(timeLeft > 0) countdownEl.innerText = timeLeft;
            else {
                clearInterval(timer);
                countdownEl.style.display = 'none';
                statusMsg.innerText = "ƒêANG R∆†I...";
                spawnDataWave();
            }
        }, 1000);
    }

    function spawnDataWave() {
        if(!gameActive) return;
        const q = questions[currentQ];
        const currentQ_Snapshot = currentQ;

        // Ch·ªâ t·∫°o danh s√°ch c√°c ƒë√°p √°n ch∆∞a b·ªã ch·ªçn sai
        let availableIndices = [0, 1, 2, 3].filter(idx => !wrongAnswersForThisQ.includes(idx));
        availableIndices.sort(() => Math.random() - 0.5);

        availableIndices.forEach((answerIndex, i) => {
            setTimeout(() => {
                if(gameActive && currentQ_Snapshot === currentQ && !wrongAnswersForThisQ.includes(answerIndex)) {
                    createBox(q.a[answerIndex], answerIndex === q.c, currentQ_Snapshot, answerIndex);
                }
            }, i * 2000);
        });

        // T·ª± ƒë·ªông l·∫∑p l·∫°i n·∫øu ch∆∞a ch·ªçn ƒë√∫ng sau khi h·∫øt c√°c h·ªôp
        clearTimeout(waveTimeout);
        waveTimeout = setTimeout(() => {
            if(gameActive && currentQ_Snapshot === currentQ) spawnDataWave();
        }, availableIndices.length * 2000 + 3000);
    }

    function createBox(text, isCorrect, qIndexAtSpawn, ansIdx) {
        const box = document.createElement('div');
        box.className = 'falling-data';
        box.innerText = text;
        box.style.left = (50 + Math.random() * (gameArea.offsetWidth - 220)) + 'px';
        gameArea.appendChild(box);

        let top = -80;
        const fall = setInterval(() => {
            if(!gameActive || qIndexAtSpawn !== currentQ || wrongAnswersForThisQ.includes(ansIdx)) { 
                clearInterval(fall); box.remove(); return; 
            }

            top += 2.3;
            box.style.top = top + 'px';

            let rRect = robot.getBoundingClientRect();
            let bRect = box.getBoundingClientRect();

            if(!(rRect.right < bRect.left || rRect.left > bRect.right || rRect.bottom < bRect.top || rRect.top > bRect.bottom)) {
                clearInterval(fall);
                box.remove();
                
                if(isCorrect) {
                    currentScore += 20;
                    confetti({ particleCount: 80, spread: 100, origin: { y: 0.8 } });
                    currentQ++;
                    statusMsg.innerText = "XU·∫§T S·∫ÆC!";
                    setTimeout(loadNextQuestion, 1200);
                } else {
                    currentScore -= 10;
                    wrongAnswersForThisQ.push(ansIdx); // Th√™m v√†o danh s√°ch ƒëen
                    robot.classList.add('hit-flash');
                    statusMsg.innerText = "SAI R·ªíI! ƒê√É LO·∫†I B·ªé ƒê√ÅP √ÅN N√ÄY.";
                    setTimeout(() => robot.classList.remove('hit-flash'), 200);
                }
                document.getElementById('current-score').innerText = currentScore;
            }

            if(top > gameArea.offsetHeight) { clearInterval(fall); box.remove(); }
        }, 20);
    }

    function endGame() {
        gameActive = false;
        clearTimeout(waveTimeout);
        document.getElementById('final-screen').style.display = 'flex';
        document.getElementById('final-score').innerText = currentScore + " PTS";
        let rank = currentScore >= 180 ? "B·∫¨C TH·∫¶Y D·ªÆ LI·ªÜU AI üèÜ" : "K·ª∏ THU·∫¨T VI√äN AI üõ†Ô∏è";
        document.getElementById('final-rank').innerText = rank;

        const name = document.getElementById('p-name').value;
        const lop = document.getElementById('p-class').value;
        const url = `${CONFIG_FORM.formAction}?${CONFIG_FORM.entryName}=${encodeURIComponent(name)}&${CONFIG_FORM.entryClass}=${encodeURIComponent(lop)}&${CONFIG_FORM.entryScore}=${currentScore}&submit=Submit`;
        fetch(url, { mode: 'no-cors' });
    }
</script>
</body>
</html>
